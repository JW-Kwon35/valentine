<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Will you be my Valentine?</title>
  <style>
    :root{
      --bg1:#ff9a9e;
      --bg2:#fad0c4;
      --card:#ffffffcc;
      --text:#2b2b2b;
      --shadow: 0 20px 60px rgba(0,0,0,.18);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(1000px 700px at 80% 20%, rgba(255,255,255,.45), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      display:grid;
      place-items:center;
      padding:24px;
    }

    .bg-heart{
      position:fixed;
      top:110vh;
      left:0;
      font-size:18px;
      opacity:.18;
      filter: blur(.1px);
      pointer-events:none;
      user-select:none;
    }

    main.card{
      width:min(520px, 92vw);
      background:var(--card);
      border:1px solid rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      border-radius:26px;
      box-shadow:var(--shadow);
      padding:28px 22px;
      text-align:center;
      position:relative;
    }

    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.7);
      border:1px solid rgba(0,0,0,.06);
      font-size:13px;
      margin-bottom:14px;
    }

    h1{
      margin:8px 0 8px;
      font-size:clamp(26px, 4.5vw, 38px);
      line-height:1.15;
      letter-spacing:-.02em;
    }
    p#subtitle{
      margin:0 auto 18px;
      font-size:15px;
      line-height:1.5;
      opacity:.92;
      max-width:42ch;
      min-height:48px;
    }

    .buttons{
      position:relative;
      display:flex;
      justify-content:center;
      gap:12px;
      padding:14px 0 6px;
      min-height:64px;
    }
    button{
      border:0;
      cursor:pointer;
      border-radius:16px;
      padding:14px 18px;
      font-weight:800;
      font-size:16px;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px) scale(.99); }

    #yesBtn{
      background: linear-gradient(180deg, #ff4d6d, #ff2d55);
      color:white;
      transform: scale(1);
    }
    #yesBtn:hover{ filter: brightness(1.02); }

    #noBtn{
      background: rgba(255,255,255,.9);
      color:#1f1f1f;
      border:1px solid rgba(0,0,0,.08);
      position:relative;
    }

    .row{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .secondary{
      background: rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.08);
      color:#333;
      box-shadow:none;
      font-weight:700;
      padding:10px 14px;
      border-radius:14px;
      font-size:14px;
    }

    .overlay{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.28);
      z-index:50;
      padding:22px;
    }
    .overlay.show{ display:grid; }
    .modal{
      width:min(520px, 92vw);
      background: rgba(255,255,255,.92);
      border-radius:26px;
      box-shadow: var(--shadow);
      padding:26px 20px;
      text-align:center;
      border:1px solid rgba(0,0,0,.06);
    }
    .modal h2{
      margin:8px 0 6px;
      font-size:clamp(22px, 4vw, 30px);
    }
    .modal p{
      margin:0 auto 14px;
      opacity:.9;
      line-height:1.6;
      max-width:46ch;
    }

    .confetti{
      position:fixed;
      top:0;
      left:0;
      pointer-events:none;
      user-select:none;
      z-index:60;
    }

    .note{
      margin-top:10px;
      font-size:12px;
      opacity:.72;
    }

    #commentOverlay{ z-index:70; }
    #commentInput{
      width:100%;
      min-height:110px;
      resize:none;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      font-size:14px;
      line-height:1.5;
      outline:none;
      margin-top:8px;
    }
    #commentInput:focus{
      border-color: rgba(255,45,85,.45);
      box-shadow: 0 0 0 3px rgba(255,45,85,.12);
    }

    /* flower overlay */
    #flowerOverlay{ z-index:72; }
    .flower-btn-yes{
      background: linear-gradient(180deg, #ff4d6d, #ff2d55);
      color:white;
    }
    .flower-btn-no{
      background: rgba(255,255,255,.9);
      color:#1f1f1f;
      border:1px solid rgba(0,0,0,.08);
    }

    /* address overlay */
    #addressOverlay{ z-index:74; }
    #addressInput{
      width:100%;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      font-size:15px;
      line-height:1.5;
      outline:none;
      margin-top:8px;
    }
    #addressInput:focus{
      border-color: rgba(255,45,85,.45);
      box-shadow: 0 0 0 3px rgba(255,45,85,.12);
    }

    #adminPanel{
      margin-top:18px;
      padding-top:14px;
      border-top:1px dashed rgba(0,0,0,.12);
      text-align:left;
    }
    #adminPanel h2{
      margin:0 0 8px;
      font-size:18px;
      text-align:center;
    }
    .adminTableWrap{
      margin-top:10px;
      max-height:280px;
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.65);
    }
    #adminTable{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    #adminTable th, #adminTable td{
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      vertical-align:top;
      word-break:break-word;
    }
    #adminTable th{
      position:sticky;
      top:0;
      background: rgba(255,255,255,.92);
      border-bottom:1px solid rgba(0,0,0,.08);
      text-align:left;
      font-weight:800;
    }
    #adminTable tbody tr:last-child td{ border-bottom:0; }

    @media (max-width: 380px){
      button{ padding:13px 14px; }
      .buttons{ gap:10px; }
    }
  </style>
</head>
<body>
  <main class="card" aria-live="polite">
    <div class="badge">ğŸ’Œ <span id="badgeText">valentine mode</span></div>
    <h1 id="title">Will you be my Valentine? ğŸ’˜</h1>
    <p id="subtitle">ëŒ€ë‹µì€â€¦ Yes ì•„ë‹ˆë©´ No! (ê·¼ë° NoëŠ” ì¢€ ë¶€ë„ëŸ¼ì´ ë§ì•„ ğŸƒâ€â™‚ï¸)</p>

    <div class="buttons" id="btnArea">
      <button id="yesBtn" type="button">Yes ğŸ’—</button>
      <button id="noBtn" type="button">No ğŸ™ˆ</button>
    </div>

    <div class="row" id="actionRow">
      <button class="secondary" id="copyBtn" type="button">ğŸ”— ë§í¬ ë³µì‚¬</button>
      <button class="secondary" id="resetBtn" type="button">â†©ï¸ ë¦¬ì…‹</button>
    </div>

    <div class="note" id="footerNote">* ì¥ë‚œì€ ì¥ë‚œìœ¼ë¡œ! ì¶©ë¶„íˆ ì¹œí•œ ì‚¬ì´ì—ë§Œ ğŸ˜‡</div>

    <section id="adminPanel" hidden>
      <h2>ğŸ“‹ ì‘ë‹µ ë³´ê¸°</h2>
      <p class="note" style="margin-top:0; opacity:.85;">
        * ì´ í™”ë©´ì€ ë§Œë“  ì‚¬ëŒ(ë³´ë‚¸ ì‚¬ëŒ)ìš©. URLì— <b>admin=1</b>ì„ ë¶™ì´ë©´ ì—´ë ¤ìš”.
      </p>

      <div class="row" style="margin-top:6px;">
        <button class="secondary" id="refreshBtn" type="button">â†» ìƒˆë¡œê³ ì¹¨</button>
        <button class="secondary" id="copyAdminBtn" type="button">ğŸ”’ ê²°ê³¼ ë§í¬ ë³µì‚¬</button>
      </div>

      <div id="adminStatus" class="note" style="margin-top:8px; min-height:18px;"></div>

      <div class="adminTableWrap">
        <table id="adminTable" aria-label="responses">
          <thead>
            <tr>
              <th>ì‹œê°„</th>
              <th>ìƒëŒ€</th>
              <th>ì„ íƒ</th>
              <th>ê½ƒ</th>
              <th>ì£¼ì†Œ</th>
              <th>ì½”ë©˜íŠ¸</th>
            </tr>
          </thead>
          <tbody id="adminTbody">
            <tr><td colspan="6" style="padding:12px;">admin=1ë¡œ ì—´ë©´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Final celebration overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div style="font-size:42px; line-height:1;">ğŸ’–</div>
      <h2 id="modalTitle">Yay!!!</h2>
      <p id="modalText">ì˜¬í•´ ë°œë Œíƒ€ì¸ì€ ìš°ë¦¬ ê±°ë‹¤ ğŸ¥°</p>
      <div class="row">
        <button id="closeBtn" type="button">ë‹«ê¸°</button>
        <button class="secondary" id="copyBtn2" type="button">ğŸ”— ê²°ê³¼ ê³µìœ í•˜ê¸°</button>
      </div>
      <div class="note" id="shareStatus" style="min-height:18px;"></div>
    </div>
  </div>

  <!-- Comment overlay -->
  <div class="overlay" id="commentOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div style="font-size:42px; line-height:1;">ğŸ“</div>
      <h2 id="commentTitle">í•œë§ˆë”” ë‚¨ê²¨ì¤˜!</h2>
      <p id="commentDesc">ì„ íƒí•œ ì´ìœ ë‚˜ í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì¤˜ ğŸ˜Š</p>
      <textarea id="commentInput" maxlength="200" placeholder="(ìµœëŒ€ 200ì)"></textarea>
      <div class="row" style="margin-top:12px;">
        <button id="submitCommentBtn" type="button">ë³´ë‚´ê¸°</button>
        <button class="secondary" id="skipCommentBtn" type="button">ì½”ë©˜íŠ¸ ì—†ì´</button>
      </div>
      <div class="note" id="sendStatus" style="min-height:18px;"></div>
    </div>
  </div>

  <!-- Flower question overlay -->
  <div class="overlay" id="flowerOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div style="font-size:52px; line-height:1;">ğŸ’</div>
      <h2 id="flowerTitle">ê·¸ëŸ¼ì—ë„ ê½ƒì€ ë°›ì•„ì¤„ ê±°ì§€?</h2>
      <p id="flowerDesc">ë°œë Œíƒ€ì¸ ê½ƒë‹¤ë°œ, ë°›ì•„ì¤„ë˜? ğŸŒ¹</p>
      <div class="row" style="margin-top:14px;">
        <button class="flower-btn-yes" id="flowerYesBtn" type="button">ë°›ì„ê²Œ! ğŸŒ·</button>
        <button class="flower-btn-no" id="flowerNoBtn" type="button">ê½ƒì€ ê´œì°®ì•„ ğŸ˜…</button>
      </div>
    </div>
  </div>

  <!-- Address input overlay -->
  <div class="overlay" id="addressOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div style="font-size:42px; line-height:1;">ğŸ“®</div>
      <h2>ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
      <p>ê½ƒì„ ë³´ë‚´ë“œë¦´ ì£¼ì†Œë¥¼ ì•Œë ¤ì¤˜! ğŸš€</p>
      <input type="text" id="addressInput" placeholder="ì˜ˆ) ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123" />
      <div class="row" style="margin-top:14px;">
        <button id="addressSubmitBtn" type="button">ì…ë ¥ ğŸ“¬</button>
        <button class="secondary" id="addressCancelBtn" type="button">ì·¨ì†Œ</button>
      </div>
      <div class="note" id="addressStatus" style="min-height:18px;"></div>
    </div>
  </div>

  <script>
    // --- Personalization via query params ---
    const params = new URLSearchParams(location.search);
    const toName = (params.get("to") || params.get("name") || "").trim();
    const fromName = (params.get("from") || "").trim();

    // --- ì €ì¥(ê²°ê³¼ ë³´ê¸°) ê¸°ëŠ¥ ì„¤ì • ---
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbwUOuBF6ssNfehLML0qlNyworTrfVvswYomFhLqKG4jhjsxK5oidxQ9EhUb5NHrmTu6dg/exec";
    const ADMIN_MODE = params.get("admin") === "1";
    const ADMIN_KEY  = (params.get("k") || "").trim();

    // --- DOM refs ---
    const titleEl = document.getElementById("title");
    const badgeEl = document.getElementById("badgeText");
    if (toName && fromName){
      titleEl.textContent = `${toName}ì•„(ì•¼), ${fromName}ì˜ ë°œë Œíƒ€ì¸ì´ ë˜ì–´ì¤„ë˜? ğŸ’˜`;
      badgeEl.textContent = `to ${toName} Â· from ${fromName}`;
    } else if (toName){
      titleEl.textContent = `${toName}ì•„(ì•¼), ë‚´ ë°œë Œíƒ€ì¸ì´ ë˜ì–´ì¤„ë˜? ğŸ’˜`;
      badgeEl.textContent = `to ${toName}`;
    } else {
      badgeEl.textContent = `shareable link inside`;
    }

    const subtitle    = document.getElementById("subtitle");
    const yesBtn      = document.getElementById("yesBtn");
    const noBtn       = document.getElementById("noBtn");
    const btnArea     = document.getElementById("btnArea");

    const overlay     = document.getElementById("overlay");
    const modalTitle  = document.getElementById("modalTitle");
    const modalText   = document.getElementById("modalText");
    const closeBtn    = document.getElementById("closeBtn");
    const copyBtn     = document.getElementById("copyBtn");
    const copyBtn2    = document.getElementById("copyBtn2");
    const resetBtn    = document.getElementById("resetBtn");

    const commentOverlay   = document.getElementById("commentOverlay");
    const commentTitle     = document.getElementById("commentTitle");
    const commentInput     = document.getElementById("commentInput");
    const submitCommentBtn = document.getElementById("submitCommentBtn");
    const skipCommentBtn   = document.getElementById("skipCommentBtn");
    const sendStatus       = document.getElementById("sendStatus");

    const flowerOverlay = document.getElementById("flowerOverlay");
    const flowerTitle   = document.getElementById("flowerTitle");
    const flowerDesc    = document.getElementById("flowerDesc");
    const flowerYesBtn  = document.getElementById("flowerYesBtn");
    const flowerNoBtn   = document.getElementById("flowerNoBtn");

    const addressOverlay   = document.getElementById("addressOverlay");
    const addressInput     = document.getElementById("addressInput");
    const addressSubmitBtn = document.getElementById("addressSubmitBtn");
    const addressCancelBtn = document.getElementById("addressCancelBtn");
    const addressStatus    = document.getElementById("addressStatus");

    const adminPanel   = document.getElementById("adminPanel");
    const refreshBtn   = document.getElementById("refreshBtn");
    const copyAdminBtn = document.getElementById("copyAdminBtn");
    const adminStatus  = document.getElementById("adminStatus");
    const adminTbody   = document.getElementById("adminTbody");
    const actionRow    = document.getElementById("actionRow");
    const footerNote   = document.getElementById("footerNote");

    // --- State ---
    let noAttempts  = 0;
    const MAX_NO    = 10;
    let noIsRunning = true;
    let lastMoveAt  = 0;

    let selectedChoice   = null;
    let collectedComment = "";
    let collectedFlower  = null;   // "yes" | "no"
    let collectedAddress = "";

    const lines = [
      "ì§„ì§œë¡œ Noâ€¦? ğŸ¥º",
      "í•œ ë²ˆë§Œ ë” ìƒê°í•´ì£¼ë©´ ì•ˆ ë¼? ğŸ’—",
      "ë‚´ê°€ ê°„ì‹ ì‚¬ì¤„ê²Œâ€¦ ğŸ«",
      "ì—¬ê¸°ê¹Œì§€ ì™”ëŠ”ë°â€¦ ì œë°œâ€¦ ğŸ™",
      "ì‹¬ì¥ì´ ìª¼ê°œì§€ëŠ” ì¤‘â€¦ ğŸ’”",
      "ì˜¤ì¼€ì´â€¦ ê·¸ë˜ë„ ë‚œ í¬ê¸° ëª» í•´â€¦ ğŸ˜¤",
      "ì¡°ê¸ˆë§Œ ë”! (7ë²ˆì§¸ì•¼) ğŸ«£",
      "ì´ê±´ ê±°ì˜ ìš´ëª…ì´ì•¼â€¦ (8ë²ˆì§¸) ğŸ§²",
      "ì§„ì§œ ë§ˆì§€ë§‰ ì§ì „â€¦ (9ë²ˆì§¸) ğŸ˜³",
      "ë¼ìŠ¤íŠ¸! ì§„ì§œ ë¼ìŠ¤íŠ¸! (10ë²ˆì§¸) ğŸ¥¹",
    ];

    // --- Helpers ---
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function endpointReady(){
      return ENDPOINT_URL && /^https?:\/\//.test(ENDPOINT_URL) && !ENDPOINT_URL.includes("PASTE_YOUR");
    }

    function fmtKST(ts){
      const d = new Date(ts);
      if (isNaN(d)) return ts || "";
      return d.toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });
    }

    function setYesScale(){
      const s = clamp(1 + noAttempts * 0.12, 1, 1.9);
      yesBtn.style.transform = `scale(${s})`;
      yesBtn.style.boxShadow = `0 ${10 + s*3}px ${20 + s*10}px rgba(0,0,0,.14)`;
    }

    // --- No button portal (iOS Safari fix) ---
    function ensureNoPortal(){
      if (noBtn.dataset.portaled === "1") return;
      const rect = noBtn.getBoundingClientRect();
      const ph = document.createElement("span");
      ph.id = "noPlaceholder";
      ph.style.display = "inline-block";
      ph.style.width = rect.width + "px";
      ph.style.height = rect.height + "px";
      ph.style.verticalAlign = "middle";
      const cs = getComputedStyle(noBtn);
      ph.style.margin = cs.margin;
      noBtn.parentNode.insertBefore(ph, noBtn);
      document.body.appendChild(noBtn);
      noBtn.dataset.portaled = "1";
      noBtn.style.position = "fixed";
      noBtn.style.margin = "0";
      noBtn.style.zIndex = "40";
    }

    function returnNoToCard(){
      const ph = document.getElementById("noPlaceholder");
      if (ph && ph.parentNode){
        ph.parentNode.insertBefore(noBtn, ph);
        ph.remove();
      } else {
        btnArea.appendChild(noBtn);
      }
      noBtn.dataset.portaled = "";
      noBtn.style.position = "relative";
      noBtn.style.left = "";
      noBtn.style.top  = "";
      noBtn.style.margin = "";
      noBtn.style.zIndex = "";
    }

    function viewportBox(){
      const vv = window.visualViewport;
      if (vv) return { left: vv.offsetLeft, top: vv.offsetTop, width: vv.width, height: vv.height };
      return { left: 0, top: 0, width: window.innerWidth, height: window.innerHeight };
    }

    function moveNoButton(){
      if (!noIsRunning) return;
      const now = performance.now();
      if (now - lastMoveAt < 90) return;
      lastMoveAt = now;
      ensureNoPortal();
      const rect = noBtn.getBoundingClientRect();
      const pad = 12;
      const vp = viewportBox();
      let minX = vp.left + pad, minY = vp.top + pad;
      let maxX = vp.left + vp.width - rect.width - pad;
      let maxY = vp.top + vp.height - rect.height - pad;
      if (maxX < minX) maxX = minX;
      if (maxY < minY) maxY = minY;
      noBtn.style.left = (minX + Math.random() * (maxX - minX)) + "px";
      noBtn.style.top  = (minY + Math.random() * (maxY - minY)) + "px";
    }

    // --- Background hearts ---
    function backgroundHearts(){
      const emojis = ["ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’•","â¤ï¸"];
      const heart = document.createElement("div");
      heart.className = "bg-heart";
      heart.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      heart.style.left = (Math.random() * 100) + "vw";
      heart.style.fontSize = (14 + Math.random()*18) + "px";

      const drift = (Math.random()*40 - 20);
      const dur = (8 + Math.random()*8) * 1000;

      document.body.appendChild(heart);

      const start = performance.now();
      function tick(now){
        const p = Math.min((now - start) / dur, 1);
        const ty = -140 * p;
        const tx = drift * p;
        const r = 18 * p;
        heart.style.transform = `translateY(${ty}vh) translateX(${tx}vw) rotate(${r}deg)`;
        if (p < 1) requestAnimationFrame(tick);
        else heart.remove();
      }
      requestAnimationFrame(tick);
    }
    setInterval(backgroundHearts, 700);

    function confettiHearts(count=30){
      const emojis = ["ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’•","â¤ï¸"];
      const vh = window.innerHeight;
      const particles = [];

      for (let i=0; i<count; i++){
        const c = document.createElement("div");
        c.className = "confetti";
        c.textContent = emojis[Math.floor(Math.random()*emojis.length)];
        c.style.fontSize = (16 + Math.random()*26) + "px";
        c.style.opacity = (0.65 + Math.random()*0.35).toFixed(2);
        c.style.willChange = "transform";
        document.body.appendChild(c);

        particles.push({
          el: c,
          x: Math.random() * window.innerWidth,
          startY: -30 - Math.random()*40,
          endY: vh * 1.1,
          rot0: Math.random()*60 - 30,
          dur: 2800 + Math.random()*2600,
          born: performance.now()
        });
      }

      function tick(now){
        let alive = false;
        for (let i=0; i<particles.length; i++){
          const p = particles[i];
          if (!p) continue;
          const t = Math.min((now - p.born) / p.dur, 1);
          if (t < 1){
            alive = true;
            const y = p.startY + (p.endY - p.startY) * t;
            const r = p.rot0 + 25 * t;
            p.el.style.transform = `translate3d(${p.x}px,${y}px,0) rotate(${r}deg)`;
          } else {
            p.el.remove();
            particles[i] = null;
          }
        }
        if (alive) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    // ============================================================
    //  FLOW:
    //  1. Yes/No ì„ íƒ
    //  2. ì½”ë©˜íŠ¸ ì…ë ¥ (ì„ íƒ)
    //  3. "ê½ƒì€ ë°›ì•„ì¤„ ê±°ì§€?" (Yes / No)
    //  4. Yes â†’ ì£¼ì†Œ ì…ë ¥ (ì…ë ¥ / ì·¨ì†Œ)
    //     No  â†’ ë°”ë¡œ ìµœì¢…
    //  5. ìµœì¢… ê²°ê³¼ ì €ì¥ + ê²°ê³¼ ê³µìœ í•˜ê¸° í™”ë©´
    // ============================================================

    // --- Step 1: Comment ---
    function openComment(choice){
      selectedChoice = choice;
      sendStatus.textContent = "";
      commentInput.value = "";
      commentTitle.textContent = choice === "yes" ? "Yes ì„ íƒ! ğŸ’—" : "No ì„ íƒ! ğŸ™ˆ";
      commentOverlay.classList.add("show");
      commentInput.focus({ preventScroll: true });
    }
    function closeComment(){ commentOverlay.classList.remove("show"); }

    submitCommentBtn.addEventListener("click", () => {
      collectedComment = commentInput.value.trim();
      closeComment();
      openFlowerQuestion();
    });
    skipCommentBtn.addEventListener("click", () => {
      collectedComment = "";
      closeComment();
      openFlowerQuestion();
    });
    commentOverlay.addEventListener("click", (e) => {
      if (e.target === commentOverlay) closeComment();
    });

    // --- Step 2: Flower question ---
    function openFlowerQuestion(){
      if (selectedChoice === "yes"){
        flowerTitle.textContent = "ê·¸ëŸ¬ë©´ ê½ƒë„ ë°›ì•„ì¤„ ê±°ì§€? ğŸ’";
        flowerDesc.textContent = "ë°œë Œíƒ€ì¸ ê½ƒë‹¤ë°œ, ê°™ì´ ë°›ì•„ì¤˜! ğŸŒ¹";
      } else {
        flowerTitle.textContent = "ê·¸ë˜ë„ ê½ƒì€ ë°›ì•„ì¤„ ê±°ì§€? ğŸ’";
        flowerDesc.textContent = "ë§ˆìŒì€ ê±°ì ˆí•´ë„â€¦ ê½ƒ í•œ ë‹¤ë°œ ì–´ë•Œ? ğŸŒ·";
      }
      flowerOverlay.classList.add("show");
    }
    function closeFlower(){ flowerOverlay.classList.remove("show"); }

    flowerYesBtn.addEventListener("click", () => {
      collectedFlower = "yes";
      closeFlower();
      openAddressInput();          // ê½ƒ ìˆ˜ë½ â†’ ì£¼ì†Œ ì…ë ¥
    });
    flowerNoBtn.addEventListener("click", () => {
      collectedFlower = "no";
      closeFlower();
      finalizeAll();               // ê½ƒ ê±°ì ˆ â†’ ë°”ë¡œ ìµœì¢…
    });

    // --- Step 3: Address input ---
    function openAddressInput(){
      addressInput.value = "";
      addressStatus.textContent = "";
      addressOverlay.classList.add("show");
      addressInput.focus({ preventScroll: true });
    }
    function closeAddress(){ addressOverlay.classList.remove("show"); }

    addressSubmitBtn.addEventListener("click", () => {
      const addr = addressInput.value.trim();
      if (!addr){
        addressStatus.textContent = "ì£¼ì†Œë¥¼ ì…ë ¥í•´ì¤˜! âœï¸";
        return;
      }
      collectedAddress = addr;
      closeAddress();
      finalizeAll();
    });
    addressCancelBtn.addEventListener("click", () => {
      collectedAddress = "";
      closeAddress();
      finalizeAll();
    });

    // --- Last finalized result (for sharing) ---
    let finalResult = null;

    // --- Step 4: Save + Final screen ---
    async function finalizeAll(){
      if (!selectedChoice) return;

      // store for sharing
      finalResult = {
        choice: selectedChoice,
        comment: collectedComment,
        flower: collectedFlower,
        address: collectedAddress,
        to: toName || "",
        from: fromName || ""
      };

      // í™”ë©´ ë¨¼ì € ë³´ì—¬ì£¼ê¸° (ë”œë ˆì´ ì—†ì´!)
      if (selectedChoice === "yes") showYes();
      else showNo();

      // ì €ì¥ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ (ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
      saveResponse(selectedChoice, collectedComment, collectedFlower, collectedAddress);

      // reset
      selectedChoice   = null;
      collectedComment = "";
      collectedFlower  = null;
      collectedAddress = "";
    }

    async function saveResponse(choice, comment, flower, address){
      const payload = {
        ts: new Date().toISOString(),
        choice,
        comment: comment || "",
        flower: flower || "",
        address: address || "",
        to: toName || "",
        from: fromName || "",
        href: location.href.split("#")[0],
        ua: navigator.userAgent || ""
      };

      if (!endpointReady()){
        // endpoint ë¯¸ì„¤ì •: ê²°ê³¼ ê³µìœ í•˜ê¸° ë²„íŠ¼ì—ì„œ ë³µì‚¬ ê°€ëŠ¥í•˜ë¯€ë¡œ ì—¬ê¸°ì„  ì¡°ìš©íˆ íŒ¨ìŠ¤
        return;
      }

      try{
        fetch(ENDPOINT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      }catch{
        // ì „ì†¡ ì‹¤íŒ¨í•´ë„ ê²°ê³¼ ê³µìœ í•˜ê¸° ë²„íŠ¼ìœ¼ë¡œ ê³µìœ  ê°€ëŠ¥
      }
    }

    function showYes(){
      const who = toName || "ë„ˆ";
      overlay.classList.add("show");
      modalTitle.textContent = "Yay!!! ğŸ’";
      let msg = `${who}ë‘ í•¨ê»˜ë¼ì„œ ì™„ì „ í–‰ë³µí•´ ğŸ¥°`;
      if (finalResult && finalResult.flower === "yes"){
        msg += `\nğŸŒ¹ ê½ƒë„ ë³´ë‚´ì¤„ê²Œ! ê¸°ë‹¤ë ¤!`;
      } else {
        msg += `\nê½ƒì€ ê´œì°®ë‹¤ê³  í–ˆì§€? ì•Œê² ì–´! ğŸ˜Š`;
      }
      if (finalResult && finalResult.address){
        msg += `\nğŸ“® ì£¼ì†Œë„ ì˜ ë°›ì•˜ì–´!`;
      }
      modalText.textContent = msg;
      confettiHearts(30);
    }

    function showNo(){
      const who = toName || "ë„ˆ";
      overlay.classList.add("show");
      modalTitle.textContent = "ì•Œê² ì–´ ğŸ˜Œ";
      let msg = `${who}ì˜ ë§ˆìŒë„ ì¡´ì¤‘í• ê²Œ. ê·¸ë˜ë„ ê³ ë§ˆì›Œ!`;
      if (finalResult && finalResult.flower === "yes"){
        msg += `\nğŸŒ· ê·¸ë˜ë„ ê½ƒì€ ë³´ë‚´ì¤„ê²Œ! ê¸°ë‹¤ë ¤!`;
      } else {
        msg += `\nê½ƒë„ ê´œì°®ë‹¤ë‹ˆ, ì•Œê² ì–´! ğŸ˜Š`;
      }
      if (finalResult && finalResult.address){
        msg += `\nğŸ“® ì£¼ì†Œë„ ì˜ ë°›ì•˜ì–´!`;
      }
      modalText.textContent = msg;
    }

    // --- No button ---
    noBtn.addEventListener("click", () => {
      if (!noIsRunning && noAttempts >= MAX_NO){
        openComment("no");
        return;
      }
      noAttempts++;
      subtitle.textContent = lines[Math.min(noAttempts - 1, lines.length - 1)];
      setYesScale();
      if (noAttempts >= MAX_NO){
        noIsRunning = false;
        subtitle.textContent = "ì˜¤ì¼€ì´. ì§„ì§œ Noë„ ì¡´ì¤‘í• ê²Œ. (ì´ì œ No ë²„íŠ¼ ì•ˆ ë„ë§ê°) ğŸ™‚";
        returnNoToCard();
        return;
      }
      moveNoButton();
    });

    yesBtn.addEventListener("click", () => openComment("yes"));

    // --- URL helpers ---
    function buildShareURL(){
      const url = new URL(location.href);
      url.searchParams.delete("admin");
      url.searchParams.delete("k");
      if (toName) url.searchParams.set("to", toName);
      if (fromName) url.searchParams.set("from", fromName);
      return url.toString();
    }

    function buildAdminURL(){
      const url = new URL(location.href);
      url.searchParams.set("admin", "1");
      if (fromName) url.searchParams.set("from", fromName);
      if (ADMIN_KEY) url.searchParams.set("k", ADMIN_KEY);
      return url.toString();
    }

    // --- Admin table ---
    function renderResponses(rows){
      adminTbody.innerHTML = "";
      if (!rows || !rows.length){
        adminTbody.innerHTML = '<tr><td colspan="6" style="padding:12px;">ì•„ì§ ì‘ë‹µì´ ì—†ì–´ìš”.</td></tr>';
        return;
      }
      rows.sort((a,b) => (b.ts || "").localeCompare(a.ts || ""));
      for (const r of rows){
        const tr = document.createElement("tr");
        const who     = r.to || r.who || "(ì´ë¦„ ì—†ìŒ)";
        const choice  = (r.choice || "").toLowerCase() === "yes" ? "Yes ğŸ’—" : "No ğŸ™ˆ";
        const flower  = (r.flower || "").toLowerCase() === "yes" ? "ë°›ì„ê²Œ ğŸŒ¹" : (r.flower === "no" ? "ê´œì°®ì•„ ğŸ˜…" : "â€”");
        const address = (r.address || "").trim() || "â€”";
        const comment = (r.comment || "").trim() || "â€”";
        tr.innerHTML = `
          <td>${fmtKST(r.ts)}</td>
          <td>${escapeHtml(who)}</td>
          <td>${choice}</td>
          <td>${flower}</td>
          <td>${escapeHtml(address)}</td>
          <td>${escapeHtml(comment)}</td>`;
        adminTbody.appendChild(tr);
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    }

    function loadResponses(){
      if (!endpointReady()){
        adminStatus.textContent = "ENDPOINT_URLì„ ì„¤ì •í•˜ë©´ ì—¬ê¸°ì„œ ì‘ë‹µì„ ë³¼ ìˆ˜ ìˆì–´ìš”.";
        return;
      }
      adminStatus.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      const cb = "__valListCb_" + Math.random().toString(16).slice(2);
      window[cb] = (data) => {
        if (data && data.error){
          adminStatus.textContent = data.error;
          renderResponses([]);
        } else {
          adminStatus.textContent = `ì´ ${Array.isArray(data) ? data.length : 0}ê°œ`;
          renderResponses(Array.isArray(data) ? data : []);
        }
        cleanup();
      };
      const u = new URL(ENDPOINT_URL);
      u.searchParams.set("action", "list");
      if (fromName) u.searchParams.set("from", fromName);
      if (ADMIN_KEY) u.searchParams.set("key", ADMIN_KEY);
      u.searchParams.set("callback", cb);
      const s = document.createElement("script");
      s.src = u.toString();
      s.onerror = () => { adminStatus.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨."; cleanup(); };
      document.body.appendChild(s);
      function cleanup(){
        try{ delete window[cb]; }catch{}
        if (s && s.parentNode) s.remove();
      }
    }

    // --- Copy / share ---
    async function copyLink(){
      const shareUrl = buildShareURL();
      try{
        await navigator.clipboard.writeText(shareUrl);
        subtitle.textContent = "ë§í¬ ë³µì‚¬ ì™„ë£Œ! ì´ì œ ê·¸ ì‚¬ëŒì—ê²Œ ë³´ë‚´ë©´ ë¨ ğŸ˜";
      }catch{
        window.prompt("ë³µì‚¬í•´ì„œ ë³´ë‚´ê¸°:", shareUrl);
      }
    }

    copyBtn.addEventListener("click", copyLink);

    // --- ê²°ê³¼ ê³µìœ í•˜ê¸°: ì„ íƒ ê²°ê³¼ë¥¼ í…ìŠ¤íŠ¸ë¡œ ê³µìœ  ---
    const shareStatus = document.getElementById("shareStatus");

    function buildResultText(){
      if (!finalResult) return "ì•„ì§ ê²°ê³¼ê°€ ì—†ì–´ìš”!";
      const r = finalResult;
      const who = r.to || "ìƒëŒ€ë°©";
      const from = r.from ? ` (from ${r.from})` : "";
      const choiceEmoji = r.choice === "yes" ? "ğŸ’— Yes" : "ğŸ™ˆ No";
      const flowerText = r.flower === "yes" ? "ğŸŒ¹ ë°›ì„ê²Œ!" : "ğŸ˜… ê´œì°®ì•„";
      const lines = [
        `ğŸ’˜ Valentine ê²°ê³¼${from}`,
        ``,
        `ğŸ‘¤ ${who}ì˜ ëŒ€ë‹µ:`,
        `  ì„ íƒ: ${choiceEmoji}`,
        `  ê½ƒ: ${flowerText}`,
      ];
      if (r.address) lines.push(`  ì£¼ì†Œ: ${r.address}`);
      if (r.comment) lines.push(`  ì½”ë©˜íŠ¸: ${r.comment}`);
      return lines.join("\n");
    }

    copyBtn2.addEventListener("click", async () => {
      const text = buildResultText();

      // Web Share API ì§€ì› ì‹œ (ëª¨ë°”ì¼ ë“±)
      if (navigator.share) {
        try {
          await navigator.share({ title: "Valentine ê²°ê³¼ ğŸ’˜", text });
          shareStatus.textContent = "ê³µìœ  ì™„ë£Œ! ğŸ’Œ";
          return;
        } catch(e) {
          // ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆê±°ë‚˜ ì‹¤íŒ¨ â†’ í´ë¦½ë³´ë“œë¡œ fallback
        }
      }

      // í´ë¦½ë³´ë“œ ë³µì‚¬ fallback
      try {
        await navigator.clipboard.writeText(text);
        shareStatus.textContent = "ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ëì–´! ë¶™ì—¬ë„£ê¸°ë¡œ ë³´ë‚´ì¤˜ ğŸ“‹";
      } catch {
        window.prompt("ë³µì‚¬í•´ì„œ ë³´ë‚´ê¸°:", text);
      }
    });

    closeBtn.addEventListener("click", () => overlay.classList.remove("show"));
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) overlay.classList.remove("show");
    });

    resetBtn.addEventListener("click", () => {
      noAttempts = 0;
      noIsRunning = true;
      yesBtn.style.transform = "scale(1)";
      yesBtn.style.boxShadow = "";
      subtitle.textContent = "ëŒ€ë‹µì€â€¦ Yes ì•„ë‹ˆë©´ No! (ê·¼ë° NoëŠ” ì¢€ ë¶€ë„ëŸ¼ì´ ë§ì•„ ğŸƒâ€â™‚ï¸)";
      returnNoToCard();
    });

    // --- Admin mode ---
    copyAdminBtn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(buildAdminURL());
        adminStatus.textContent = "ê²°ê³¼ ë§í¬ ë³µì‚¬ ì™„ë£Œ!";
      }catch{
        window.prompt("ë³µì‚¬í•´ì„œ ë³´ê´€í•˜ê¸°:", buildAdminURL());
      }
    });
    refreshBtn.addEventListener("click", loadResponses);

    if (ADMIN_MODE){
      btnArea.style.display = "none";
      if (actionRow) actionRow.style.display = "none";
      if (footerNote) footerNote.style.display = "none";
      adminPanel.hidden = false;
      titleEl.textContent = `${fromName ? fromName + "ì˜ " : ""}ì‘ë‹µ ë³´ê¸° ğŸ“‹`;
      badgeEl.textContent = fromName ? `from ${fromName} Â· admin` : "admin";
      subtitle.textContent = "ìƒëŒ€ë°©ì´ ë‚¨ê¸´ ì„ íƒ, ê½ƒ ìˆ˜ë½, ì£¼ì†Œ, ì½”ë©˜íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.";
      loadResponses();
    }

    if (params.get("forceNo") === "1"){
      noIsRunning = false;
      subtitle.textContent = "Noë„ ê°€ëŠ¥! (forceNo=1)";
    }
  </script>
</body>
</html>
